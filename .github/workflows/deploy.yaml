name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout Code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Docker Login
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Build & Push Image (Hardcoded Tag)
    - name: Build and Push Docker image
      uses: docker/build-push-action@v4
      id: build-push
      with:
        context: .
        push: true
        # Here is the manual tag you requested:
        tags: megupatil/hello-world-k8s:latest

    # 4. Setup Kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    # 5. Authenticate (Service Account Token Method)
    - name: Create Kubeconfig
      run: |
        # 1. Set Cluster URL
        kubectl config set-cluster my-cluster --server="${{ secrets.K8S_SERVER }}"
        
        # 2. Set CA Certificate
        echo "${{ secrets.K8S_CA }}" > ca.crt
        kubectl config set-cluster my-cluster --certificate-authority=ca.crt
        
        # 3. Set Service Account Token
        kubectl config set-credentials github-deployer --token="${{ secrets.K8S_TOKEN }}"
        
        # 4. Create Context
        kubectl config set-context my-context --cluster=my-cluster --user=github-deployer
        kubectl config use-context my-context

    # 6. Deploy
    - name: Deploy to Cluster
      run: |
        # Inject the manual image name into deployment.yaml
        # We explicitly use 'megupatil' here to match the build step
        sed -i "s|image: .*|image: docker.io/megupatil/hello-world-k8s:latest|g" k8s/deployment.yaml
        
        # Test connection
        kubectl version --short
        
        # Apply Manifests
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
        # Restart Deployment
        kubectl rollout restart deployment/hello-world-app
