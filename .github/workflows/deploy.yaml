name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout Code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Docker Login
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Build & Push Image
    - name: Build and Push Docker Image
      id: build-push
      run: |
        # Force lowercase to avoid Docker tag errors
        USER_LOWER=$(echo "${{ secrets.DOCKER_USERNAME }}" | tr '[:upper:]' '[:lower:]' | xargs)
        IMAGE="$USER_LOWER/hello-world-k8s"
        
        docker build -t $IMAGE:latest .
        docker push $IMAGE:latest
        
        echo "image=$IMAGE" >> $GITHUB_OUTPUT

    # 4. Setup Kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    # 5. Authenticate (NO AWS - Pure Kubernetes Token)
    # We build the config file manually using your secrets
    - name: Create Kubeconfig
      run: |
        # 1. Set Cluster URL
        kubectl config set-cluster my-cluster --server="${{ secrets.K8S_SERVER }}"
        
        # 2. Set CA Certificate
        echo "${{ secrets.K8S_CA }}" > ca.crt
        kubectl config set-cluster my-cluster --certificate-authority=ca.crt
        
        # 3. Set Service Account Token
        kubectl config set-credentials github-deployer --token="${{ secrets.K8S_TOKEN }}"
        
        # 4. Create Context
        kubectl config set-context my-context --cluster=my-cluster --user=github-deployer
        kubectl config use-context my-context

    # 6. Deploy
    - name: Deploy to Cluster
      run: |
        IMAGE_NAME="${{ steps.build-push.outputs.image }}"
        
        # Inject the image name
        sed -i "s|image: .*|image: docker.io/$IMAGE_NAME:latest|g" k8s/deployment.yaml
        
        # Test connection before applying (This will print the server version if successful)
        kubectl version --short
        
        # Apply
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl rollout restart deployment/hello-world-app
